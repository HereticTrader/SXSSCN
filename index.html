<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sniffer v6.0 — Candle + Velocity Bars</title>
  <style>
    body {
      background: black;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }
    h1 { color: #0ff; }
    canvas {
      border: 1px solid #0f0;
      background: #111;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>ALCH/USDT Sniffer v6.0 — Candles + Vertical Velocity Bars</h1>
  <canvas id="chart" width="1000" height="400"></canvas>

  <script>
    const canvas = document.getElementById("chart");
    const ctx = canvas.getContext("2d");

    const candles = [];
    const velocities = [];
    const ema8 = [], ema13 = [], ema21 = [];
    let lastBid = null, lastAsk = null, lastTime = Date.now();

    const maxLen = 100;

    function calculateEMA(data, period) {
      const k = 2 / (period + 1);
      let emaArray = [];
      let ema = data[0];
      for (let i = 0; i < data.length; i++) {
        ema = data[i] * k + ema * (1 - k);
        emaArray.push(ema);
      }
      return emaArray;
    }

    // Klines (1m)
    const klineSocket = new WebSocket("wss://fstream.binance.com/ws/alchusdt@kline_1m");
    klineSocket.onmessage = (event) => {
      const data = JSON.parse(event.data).k;
      const o = parseFloat(data.o), h = parseFloat(data.h), l = parseFloat(data.l), c = parseFloat(data.c);
      candles.push({ o, h, l, c });
      if (candles.length > maxLen) candles.shift();
      drawChart();
    };

    // Book ticker for velocity
    const bookSocket = new WebSocket("wss://fstream.binance.com/ws/alchusdt@bookTicker");
    bookSocket.onmessage = (event) => {
      const d = JSON.parse(event.data);
      const bid = parseFloat(d.b), ask = parseFloat(d.a);
      const now = Date.now();
      const dt = (now - lastTime) / 1000;
      if (lastBid !== null && lastAsk !== null && dt > 0) {
        const v = (Math.abs(bid - lastBid) + Math.abs(ask - lastAsk)) / dt;
        velocities.push(v);
        if (velocities.length > maxLen) velocities.shift();
      }
      lastBid = bid;
      lastAsk = ask;
      lastTime = now;
    };

    function drawChart() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const w = canvas.width / candles.length;
      const h = canvas.height;
      const prices = candles.flatMap(c => [c.h, c.l]);
      const max = Math.max(...prices);
      const min = Math.min(...prices);
      const range = max - min;

      const closes = candles.map(c => c.c);
      const ema8Arr = calculateEMA(closes, 8);
      const ema13Arr = calculateEMA(closes, 13);
      const ema21Arr = calculateEMA(closes, 21);

      candles.forEach((c, i) => {
        const x = i * w;
        const oY = h - ((c.o - min) / range) * h;
        const cY = h - ((c.c - min) / range) * h;
        const hY = h - ((c.h - min) / range) * h;
        const lY = h - ((c.l - min) / range) * h;
        const color = c.c >= c.o ? "#0f0" : "#f00";

        // Wicks
        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(x + w / 2, hY);
        ctx.lineTo(x + w / 2, lY);
        ctx.stroke();

        // Body
        ctx.fillStyle = color;
        ctx.fillRect(x + 1, Math.min(oY, cY), w - 2, Math.max(2, Math.abs(oY - cY)));

        // Velocity Bar
        if (velocities[i]) {
          const vh = Math.min(velocities[i] * 1000000, h / 5);
          ctx.fillStyle = "yellow";
          ctx.fillRect(x + w - 3, hY - vh, 2, vh);
        }
      });

      // EMA lines
      drawLine(ema8Arr, "#8888ff");
      drawLine(ema13Arr, "#ffaa00");
      drawLine(ema21Arr, "#00ffff");
    }

    function drawLine(arr, color) {
      ctx.strokeStyle = color;
      ctx.beginPath();
      const h = canvas.height;
      const prices = candles.flatMap(c => [c.h, c.l]);
      const max = Math.max(...prices);
      const min = Math.min(...prices);
      const range = max - min;
      arr.forEach((val, i) => {
        const y = h - ((val - min) / range) * h;
        const x = i * (canvas.width / candles.length) + 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }
  </script>
</body>
</html>
