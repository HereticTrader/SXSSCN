<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ALCHUSDT Sniffer v3.0</title>
  <style>
    body {
      background: black;
      color: #0f0;
      font-family: monospace;
      padding: 20px;
    }
    h1 { color: #0ff; }
    .velocity { font-size: 1.8em; margin-top: 10px; }
    .highlight { color: #ff0; }
    canvas { border: 1px solid #0f0; background: #111; margin-top: 20px; }

    #velocityBarContainer { width: 100%; background: #111; height: 20px; margin-top: 10px; border: 1px solid #0f0; }
    #velocityBar { height: 100%; width: 0%; background: linear-gradient(to right, #0f0, #ff0, #f00); transition: width 0.1s ease-in-out; }

    #sizeBars { display: flex; margin-top: 15px; height: 20px; }
    #bidBar { background: green; height: 100%; }
    #askBar { background: red; height: 100%; }

    .section-title { margin-top: 20px; color: #0ff; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ALCH/USDT AI Sniffer v3.0</h1>

  <div>Top Bid: <span id="topBid">...</span></div>
  <div>Top Ask: <span id="topAsk">...</span></div>
  <div>Bid Size: <span id="bidQty">...</span></div>
  <div>Ask Size: <span id="askQty">...</span></div>

  <div class="velocity">Velocity: <span id="velocity">0.00000000</span></div>

  <div id="velocityBarContainer"><div id="velocityBar"></div></div>

  <div id="sizeBars">
    <div id="bidBar" style="width: 50%"></div>
    <div id="askBar" style="width: 50%"></div>
  </div>

  <div class="section-title">Delta Power (Buy vs Sell)</div>
  <canvas id="deltaCanvas" width="800" height="50"></canvas>

  <div class="section-title">Imbalance Line (Buy=Green, Sell=Red) + Smooth Flowline</div>
  <canvas id="imbalanceCanvas" width="800" height="80"></canvas>

  <script>
    const bidEl = document.getElementById("topBid");
    const askEl = document.getElementById("topAsk");
    const bidQtyEl = document.getElementById("bidQty");
    const askQtyEl = document.getElementById("askQty");
    const velocityEl = document.getElementById("velocity");
    const velocityBar = document.getElementById("velocityBar");
    const bidBar = document.getElementById("bidBar");
    const askBar = document.getElementById("askBar");

    const deltaCanvas = document.getElementById("deltaCanvas");
    const imbalanceCanvas = document.getElementById("imbalanceCanvas");

    const ctxDelta = deltaCanvas.getContext("2d");
    const ctxImbalance = imbalanceCanvas.getContext("2d");

    let lastBid = null, lastAsk = null, lastTime = Date.now();
    let imbalanceHistory = new Array(800).fill(0);
    let flowlineHistory = new Array(800).fill(0);

    const socket = new WebSocket("wss://fstream.binance.com/ws/alchusdt@bookTicker");

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      const bid = parseFloat(data.b);
      const ask = parseFloat(data.a);
      const bidQty = parseFloat(data.B);
      const askQty = parseFloat(data.A);

      const now = Date.now();
      const timeDiff = (now - lastTime) / 1000;

      if (lastBid !== null && lastAsk !== null && timeDiff > 0) {
        const velocity = ((Math.abs(bid - lastBid) + Math.abs(ask - lastAsk)) / timeDiff).toFixed(8);
        velocityEl.textContent = velocity;
        const v = parseFloat(velocity);
        velocityBar.style.width = Math.min(v * 1000000, 100) + "%";
        velocityEl.className = v > 0.0001 ? "velocity highlight" : "velocity";
      }

      lastBid = bid;
      lastAsk = ask;
      lastTime = now;

      bidEl.textContent = bid.toFixed(5);
      askEl.textContent = ask.toFixed(5);
      bidQtyEl.textContent = bidQty.toFixed(2);
      askQtyEl.textContent = askQty.toFixed(2);

      const total = bidQty + askQty + 0.00001;
      const bidRatio = (bidQty / total) * 100;
      bidBar.style.width = bidRatio + "%";
      askBar.style.width = (100 - bidRatio) + "%";

      // ðŸ“ˆ Delta = Buy - Sell
      drawDelta(ctxDelta, bidQty - askQty);

      // ðŸ“‰ Imbalance % = (bid - ask) / (bid + ask)
      const imbalance = (bidQty - askQty) / (bidQty + askQty + 0.00001);
      imbalanceHistory.push(imbalance);
      if (imbalanceHistory.length > 800) imbalanceHistory.shift();

      // ðŸ§® Smoothing
      const smooth = movingAverage(imbalanceHistory, 20);
      flowlineHistory.push(smooth);
      if (flowlineHistory.length > 800) flowlineHistory.shift();

      drawImbalance(ctxImbalance, imbalanceHistory, flowlineHistory);
    };

    function drawDelta(ctx, delta) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      const barHeight = Math.min(Math.abs(delta) * 2, ctx.canvas.height);
      ctx.fillStyle = delta >= 0 ? "lime" : "red";
      const y = delta >= 0 ? ctx.canvas.height - barHeight : 0;
      ctx.fillRect(399, y, 2, barHeight);
    }

    function drawImbalance(ctx, raw, smooth) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      const mid = ctx.canvas.height / 2;

      // RAW line
      ctx.beginPath();
      for (let i = 0; i < raw.length; i++) {
        const y = mid - raw[i] * mid;
        if (i === 0) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
      }
      ctx.strokeStyle = raw[raw.length - 1] >= 0 ? "lime" : "red";
      ctx.lineWidth = 1;
      ctx.stroke();

      // SMOOTH line
      ctx.beginPath();
      for (let i = 0; i < smooth.length; i++) {
        const y = mid - smooth[i] * mid;
        if (i === 0) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
      }
      ctx.strokeStyle = "#00ffff";
      ctx.lineWidth = 1.5;
      ctx.stroke();

      // Center line
      ctx.strokeStyle = "#333";
      ctx.beginPath();
      ctx.moveTo(0, mid);
      ctx.lineTo(ctx.canvas.width, mid);
      ctx.stroke();
    }

    function movingAverage(arr, period) {
      const len = arr.length;
      if (len < period) return 0;
      const subset = arr.slice(len - period);
      const sum = subset.reduce((a, b) => a + b, 0);
      return sum / period;
    }
  </script>
</body>
</html>
